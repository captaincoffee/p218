---
layout: default
---
{% comment %}
Deriving useful variables from page.url
 - currentCollectionSlug : string current collection slug
 - currentCollection : jekyll:collection current collection
 - currentCollectionIndexUrl : string url for current collection
 - currentCollectionDocsByCategory : array current collection documents sorted by category
   returns : [ {"name"=>"chip-seals", "items"=>[#, #]},
               {"name"=>"crack-joint-treatments", "items"=>[#]},
               {"name"=>"microsurfacing-slurry", "items"=>[#]} ]

When on a category index page, we also create :
 - currentCategorySlug : string current category slug
 - currentCategoryDatas : array { name: "Safety", slug: "safety" }
 - currentCategoryIndexUrl : string url for current category
{% endcomment %}

{% assign dirParts = page.url | split: "/"  %}
{% assign currentCollectionSlug = dirParts[2] %}
{% assign currentCollection = site.collections | where:'label',currentCollectionSlug | first %}

{% capture currentCollectionIndexUrl %}{{ site.baseurl }}/kb/{{ currentCollection.label }}/{% endcapture %}

{% assign currentCollectionDocsByCategory = currentCollection.docs | group_by: 'category' %}

{% comment %}Are we on a category page{% endcomment %}
{% if dirParts[3] != nil %}

    {% assign currentCategorySlug = dirParts[3] %}
    {% capture currentCategoryIndexUrl %}{{ currentCollectionIndexUrl }}/{{ currentCategorySlug }}/{% endcapture %}

    {% assign currentCategoryDatas = site.data.kb_setup.kb_categories[currentCollectionSlug] | where: "slug", currentCategorySlug | first %}

{% endif %}
{% assign categoryDatas = currentCollection.categories | where: "slug", currentCategorySlug | first %}

<div class="row">
  <div class="col">
    <h1 class="rubric-title">P2 Knowledge base</h1>
  </div>
</div>

<div class="row">
  <div class="col">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item">
          <a href="{{ site.baseurl }}/kb/{{ currentCollection.label }}/">
          Collection : {{ currentCollection.name }}</a>
        </li>
        <li class="breadcrumb-item">
          <a href="{{ site.baseurl }}/kb/{{ currentCollection.label }}/{{ currentCategoryDatas.slug }}/">Category : {{ currentCategoryDatas.name }}</a>
        </li>
      </ol>
    </nav>
  </div>
</div>

<div class="row">
  <div class="col-12">
{% include articles/kb-article-full.html post=page %}

    {% if page.related.size > 0 %}
      {% assign sortedArticles = page.related | sort: "date" %}

      <h3>Related articles</h3>
      <ul>

      {% for article in sortedArticles reversed %}

        {% assign articleType = site.data.kb_setup.article_types | where: "slug", article.type | first %}

        <li>
          <a href="{{ site.baseurl }}{{ article.url }}">
            <i class="{{ articleType.icon }}"></i> {{ article.title }}
          </a>
          {% assign currentCollectionSlug = article.collection %}
          {% assign currentCollection = site.collections | where:'label',currentCollectionSlug | first %}
          date: {{ article.date | date_to_string }} -
          in {{ currentCollection.name }} collection -
          matching on : <span>{{ article.commonTags | join: ", " }}</span>
        </li>
      {% endfor %}
      </ul>
    {% endif %}

  </div>
</div>
